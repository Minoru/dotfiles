#!/bin/sh

set -e

sudo ~/.scripts/mypassport-mount

time getmail

time mbsync --all

borg create \
    -v \
    --stats \
    --progress \
    --exclude-caches --keep-exclude-tags \
    --exclude '/home/minoru/cloud' \
    --exclude 'sh:**/.git/annex/' \
    --exclude 'sh:**/.stack-work/' \
    '/media/mypassport-backup/borgbackup::{now}' \
    ~

borg prune \
    --stats \
    --progress \
    --keep-daily 180 \
    --keep-weekly 260 \
    --keep-monthly 120 \
    --keep-yearly 100 \
    /media/mypassport-backup/borgbackup

borg compact \
    --cleanup-commits \
    --progress \
    --verbose \
    --threshold=1 \
    /media/mypassport-backup/borgbackup

sudo systemctl start obnam
echo "Waiting for Obnam server to start..."
sleep 3

obnam backup || echo "Obnam exited with code $?"
sudo systemctl stop obnam

sudo ~/.scripts/mypassport-umount
